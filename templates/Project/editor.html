<!DOCTYPE html>
<html lang="en" class="editor-mode"> <!-- Start in editor mode by default -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Markdown Editor - {{ filename }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='Project/editor.css') }}"> <!-- Link to editor.css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='Project/Preview.css') }}">
    <!-- Link to Preview.css for preview styling -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
</head>

<body>
    <div class="editor-page-container">

        <main>
            <h2>{% if filename == 'new_file.md' %}Create New File{% else %}Editing: {{ filename }}{% endif %}</h2>

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            <form method="POST">
                <div class="form-actions">
                    <button type="submit" class="save-button">Save</button>
                    <a href="{{ url_for('readme_page', filename=filename.replace('.md', '')) }}"
                        class="view-page-button">View Page</a>
                    <a href="{{ url_for('admin') }}" class="admin-button">Admin Panel</a>
                    <!-- Optional Admin Panel Link -->
                </div>

                <div class="mode-toggle-buttons">
                    <button type="button" class="mode-toggle-button active" data-mode="editor">Editing</button>
                    <button type="button" class="mode-toggle-button" data-mode="preview">Preview</button>
                </div>

                {% if filename == 'new_file.md' %}
                <div class="form-group">
                    <label for="new_filename">New Filename (without .md extension):</label>
                    <input type="text" class="form-control" id="new_filename" name="new_filename" required
                        placeholder="Enter filename">
                </div>
                {% endif %}

                <div class="editor-container">
                    <div class="editor-pane">
                        <textarea id="markdown-editor" name="markdown_content" class="form-control editor-textarea"
                            placeholder="Write your Markdown here...">{{ markdown_content|e }}</textarea>
                    </div>
                    <div class="preview-pane">
                        <h2>Preview</h2>
                        <div id="markdown-preview" class="preview-content">
                            <!-- Preview content will be loaded here by JavaScript -->
                        </div>
                    </div>
                </div>
            </form>
        </main>

    </div>

    <script>
        const markdownEditor = document.getElementById('markdown-editor');
        const markdownPreview = document.getElementById('markdown-preview');
        const modeToggleButtons = document.querySelectorAll('.mode-toggle-button');
        console.log("modeToggleButtons:", modeToggleButtons);
        console.log("markdownEditor:", markdownEditor);
        console.log("markdownPreview:", markdownPreview);
        const htmlElement = document.documentElement;
    
        function updatePreview() {
            const markdownText = markdownEditor.value;
            fetch('/preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ markdown: markdownText })
            })
                .then(response => response.json())
                .then(data => {
                    markdownPreview.innerHTML = data.html_content;
                });
        }
    
        markdownEditor.addEventListener('input', updatePreview);
        updatePreview(); // Initial preview on page load
    
        modeToggleButtons.forEach(button => {
            button.addEventListener('click', function () {
                const mode = this.dataset.mode;
                console.log("Mode button clicked:", mode);
    
                modeToggleButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
    
                if (mode === 'editor') {
                    htmlElement.classList.remove('preview-mode');
                    htmlElement.classList.add('editor-mode');
                } else if (mode === 'preview') {
                    htmlElement.classList.remove('editor-mode');
                    htmlElement.classList.add('preview-mode');
                    updatePreview(); // RE-ENABLED this line - call updatePreview when switching to preview mode
                }
            });
        });
        document.querySelector('.save-button').addEventListener('click', function () {
            this.textContent = "Saving...";
            setTimeout(() => { this.textContent = "Save"; }, 1000);
        });
    </script>
</body>

</html>